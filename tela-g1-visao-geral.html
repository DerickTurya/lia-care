<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de LicenÃ§as - Lia Care</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/lia-sync.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">LIA</div>
                <div class="logo-text">
                    <h1>Lia Care</h1>
                    <p>LicenÃ§as e Afastamentos</p>
                </div>
            </div>
            <div class="user-info">
                <span>ğŸ‘”</span>
                <span>Maria Santos - Gestora</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">GestÃ£o de LicenÃ§as da Equipe</h2>
                <p class="card-subtitle">Acompanhe o status das licenÃ§as mÃ©dicas da sua equipe</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Colaboradores afastados</div>
                    <div class="stat-value" id="statActive">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">LicenÃ§as cadastradas</div>
                    <div class="stat-value" id="statTotal">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Novas (nÃ£o visualizadas)</div>
                    <div class="stat-value" style="color: var(--warning-color);" id="statPending">0</div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- NotificaÃ§Ãµes em tempo real -->
            <div id="notificationBanner" style="display: none; background: linear-gradient(135deg, #4299E1 0%, #6B46C1 100%); color: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 24px; animation: slideDown 0.4s ease-out;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px;">ğŸ””</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; margin-bottom: 4px;" id="notifTitle">Nova licenÃ§a cadastrada!</div>
                        <div style="font-size: 14px; opacity: 0.95;" id="notifMessage">Um colaborador acabou de cadastrar uma licenÃ§a</div>
                    </div>
                    <button onclick="dismissNotification()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Ver
                    </button>
                </div>
            </div>

            <style>
                @keyframes slideDown {
                    from {
                        opacity: 0;
                        transform: translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
                .pulse {
                    animation: pulse 2s infinite;
                }
            </style>

            <div class="ai-message">
                <div class="ai-message-header">
                    <span>ğŸ¤–</span>
                    <span>LIA - Assistente Inteligente</span>
                </div>
                <div class="ai-message-content">
                    <p style="margin-bottom: 16px; font-size: 16px;"><strong>OlÃ¡, Maria! ğŸ‘‹ Bem-vinda ao seu painel.</strong></p>
                    <p style="margin-bottom: 12px;">Estou monitorando as licenÃ§as da sua equipe em tempo real.</p>
                    <p style="margin-bottom: 12px; font-size: 15px; font-weight: 600;">O que eu faÃ§o por vocÃª:</p>
                    <ul style="margin: 12px 0; padding-left: 20px; line-height: 2;">
                        <li>ğŸ“Š <strong>Consolido</strong> todas as informaÃ§Ãµes em um sÃ³ lugar</li>
                        <li>ğŸ”” <strong>Te notifico</strong> sobre novos afastamentos</li>
                        <li>âš ï¸ <strong>Destaco</strong> pendÃªncias que precisam de atenÃ§Ã£o</li>
                        <li>ğŸ“ˆ <strong>Acompanho</strong> prazos e processos do INSS</li>
                        <li>âœ… <strong>Mantenho tudo</strong> organizado automaticamente</li>
                    </ul>
                    <p style="margin-top: 16px; font-size: 15px;">Relaxe e foque na gestÃ£o estratÃ©gica. Eu cuido da parte operacional! ğŸ’™</p>
                </div>
            </div>

            <h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px;">LicenÃ§as recentes</h3>

            <div id="licensesList">
                <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
                    <p>Nenhuma licenÃ§a cadastrada ainda</p>
                    <p style="font-size: 14px; margin-top: 8px;">Quando um colaborador cadastrar uma licenÃ§a, ela aparecerÃ¡ aqui automaticamente!</p>
                </div>
            </div>

            <div class="divider"></div>

            <h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px;">AÃ§Ãµes pendentes</h3>

            <div class="list-item" style="border-left: 4px solid var(--warning-color);">
                <div class="list-item-content">
                    <h3>Revisar documentaÃ§Ã£o</h3>
                    <p>Pedro Santos aguarda validaÃ§Ã£o de documentos complementares</p>
                </div>
                <div class="list-item-action" style="color: var(--warning-color);">Revisar â†’</div>
            </div>

            <div class="list-item" style="border-left: 4px solid var(--warning-color);">
                <div class="list-item-content">
                    <h3>AtualizaÃ§Ã£o necessÃ¡ria</h3>
                    <p>Juliana Lima - Retorno previsto foi alterado</p>
                </div>
                <div class="list-item-action" style="color: var(--warning-color);">Revisar â†’</div>
            </div>

            <div class="alert alert-info mt-3">
                <strong>ğŸ“Š RelatÃ³rios:</strong> Acesse relatÃ³rios detalhados de absenteÃ­smo e tendÃªncias da equipe atravÃ©s do menu principal.
            </div>

            <div style="margin-top: 32px;">
                <button onclick="createTestLicense()" class="btn btn-primary btn-block">
                    âœ¨ Criar licenÃ§a de teste
                </button>
                
                <a href="tela-05a-confirmacao.html" class="btn btn-secondary btn-block">
                    ğŸ§ª Simular cadastro de licenÃ§a
                </a>
                
                <button onclick="clearAllData()" class="btn btn-secondary btn-block">
                    ğŸ—‘ï¸ Limpar todos os dados (Reset)
                </button>
            </div>
        </div>
    </div>

    <script>
        let notificationTimeout;

        // Atualizar dashboard ao carregar
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”„ Carregando dashboard do gestor...');
            updateDashboard();
            
            // Auto-refresh a cada 3 segundos
            setInterval(() => {
                console.log('ğŸ”„ Auto-refresh...');
                updateDashboard();
            }, 3000);
        });

        // Atualizar estatÃ­sticas e lista
        function updateDashboard() {
            const licenses = liaSync.getLicenses();
            
            console.log('ğŸ“Š Atualizando dashboard. Total de licenÃ§as:', licenses.length);
            
            // Remover duplicatas antes de contar
            const uniqueLicenses = [];
            const seenKeys = new Set();
            
            licenses.forEach(license => {
                const key = `${license.employeeName || license.employee}-${license.startDate}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueLicenses.push(license);
                }
            });
            
            console.log('ğŸ“Š LicenÃ§as Ãºnicas:', uniqueLicenses.length);
            
            const stats = {
                total: uniqueLicenses.length,
                active: uniqueLicenses.filter(l => l.status !== 'ConcluÃ­da').length,
                pending: uniqueLicenses.filter(l => !l.managerViewed).length
            };
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statActive').textContent = stats.active;
            document.getElementById('statPending').textContent = stats.pending;
            
            // Atualizar lista de licenÃ§as
            renderLicenses(uniqueLicenses);
        }

        // Renderizar lista de licenÃ§as
        function renderLicenses(licenses) {
            const container = document.getElementById('licensesList');
            
            if (licenses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
                        <p>Nenhuma licenÃ§a cadastrada ainda</p>
                        <p style="font-size: 14px; margin-top: 8px;">Quando um colaborador cadastrar uma licenÃ§a, ela aparecerÃ¡ aqui automaticamente!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            licenses.forEach(license => {
                const badge = !license.managerViewed ? '<span class="badge badge-new">NOVA</span>' : '';
                const statusColor = license.status === 'Aguardando INSS' ? 'var(--warning-color)' : 'var(--success-color)';
                const employeeName = license.employeeName || license.employee || 'Colaborador';
                const condition = license.condition || license.injury || 'NÃ£o especificada';
                const startDate = license.startDate || 'Data nÃ£o informada';
                const endDate = license.endDate || 'Data nÃ£o informada';
                const status = license.status || 'Pendente';
                
                html += `
                    <div class="list-item" onclick="viewLicense('${license.id}')" style="cursor: pointer; border-left: 4px solid ${statusColor};">
                        <div class="list-item-content">
                            <h3>${employeeName}</h3>
                            ${badge}
                            <p><strong>LesÃ£o:</strong> ${condition}</p>
                            <p><strong>PerÃ­odo:</strong> ${startDate} atÃ© ${endDate}</p>
                            <p><strong>Status:</strong> ${status}</p>
                        </div>
                        <div class="list-item-action">Ver detalhes â†’</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Traduzir status
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendente',
                'active': 'Ativa',
                'completed': 'ConcluÃ­da'
            };
            return statusMap[status] || status;
        }

        // Visualizar licenÃ§a
        function viewLicense(licenseId) {
            console.log('Visualizando licenÃ§a:', licenseId);
            liaSync.markAsViewed(licenseId);
            updateDashboard();
        }

        // Mostrar notificaÃ§Ã£o
        function showNotification(notification) {
            const banner = document.getElementById('notificationBanner');
            
            document.getElementById('notifTitle').textContent = notification.title;
            document.getElementById('notifMessage').textContent = notification.message;
            
            banner.style.display = 'block';
            
            // Auto-esconder apÃ³s 10 segundos
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                dismissNotification();
            }, 10000);
        }

        // Esconde notificaÃ§Ã£o
        function dismissNotification() {
            document.getElementById('notificationBanner').style.display = 'none';
        }

        // Listener para novas licenÃ§as
        window.addEventListener('lia:newNotification', (e) => {
            console.log('ğŸ”” Nova notificaÃ§Ã£o recebida:', e.detail);
            showNotification(e.detail);
            updateDashboard();
        });

        // Listener para dados atualizados
        window.addEventListener('lia:dataUpdated', () => {
            console.log('ğŸ”„ Dados atualizados');
            updateDashboard();
        });

        // Limpar todos os dados
        function clearAllData() {
            if (confirm('Tem certeza que deseja limpar todos os dados de teste?')) {
                liaSync.clearAll();
                sessionStorage.clear(); // Limpa tambÃ©m o sessionStorage
                alert('âœ… Dados limpos com sucesso!');
                updateDashboard();
            }
        }
        
        // Criar licenÃ§a de teste diretamente
        function createTestLicense() {
            console.log('ğŸ§ª Criando licenÃ§a de teste...');
            
            const licenseData = {
                employeeName: 'JoÃ£o Silva',
                employeeId: 'COL-12345',
                position: 'Desenvolvedor Frontend',
                department: 'Tecnologia',
                manager: 'Maria Santos',
                cid: 'M54.5',
                condition: 'Lombalgia',
                days: 15,
                startDate: new Date().toLocaleDateString('pt-BR'),
                endDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR'),
                doctorName: 'Dr. Carlos Mendes',
                doctorCRM: 'CRM 12345-SP'
            };
            
            const license = liaSync.createLicense(licenseData);
            console.log('âœ… LicenÃ§a criada:', license);
            
            setTimeout(() => {
                updateDashboard();
                alert('âœ… LicenÃ§a de teste criada com sucesso!');
            }, 500);
        }

        // Auto-refresh
        window.addEventListener('lia:autoRefresh', updateDashboard);
    </script>
</body>
</html>
